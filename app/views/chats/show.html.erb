<%= render "shared/navbar" %>
<div class="main">
  <div class="container" data-controller="loading">
    <div class="p-2">
      <% if @messages.any? %>
        <%= link_to "#offcanvasmessagenavbar",
          role: "button",
          "data-bs-toggle": "offcanvas",
          "aria-controls": "offcanvasmessagenavbar",
          class: "btn" do %>
          <i class="fa-solid fa-magnifying-glass"></i>
        <% end %>
      <% end %>
    </div>
    <div class="row message-area" data-loading-target="area">
      <% if @messages.any? %>
        <% @messages.each do |message| %>
          <div class="row">
            <div class="col mb-2">
              <% unless message.who_sent === 'user' %>
                <div id='<%= "message_#{message.id}"  %>' class="chat-box" data-controller="auto-scroll">
                  <p class="chat-user-text-style">MailAI | To: <%= message.chat.receiver %></p>
                     <%= sanitize(message.content.to_s,
                          tags: %w[div p br strong b em ul ol li a],
                          attributes: %w[href]) %>

                  <%= button_to sendmail_chat_path(@chat),
                    method: :post,
                    class: "btn mail-btn",
                    params: { message_content: message.content, receiver: message.chat.receiver } do %>
                    <i class="fa-solid fa-envelope"></i>
                  <% end %>
                </div>
              <% end %>
            </div>
            <div class="col">
              <% if message.who_sent === 'user' %>
                <div id='<%= "message_#{message.id}"  %>'  class="chat-box-user">
                  <p class="chat-user-text-style"><%= current_user.email %></p>
                  <%= simple_format(message.content) %>
                </div>
              <% end %>
              <br>
            </div>
          </div>
        <% end %>
      <% else %>
        <h1 class="text-center">No messages yet.</h1>
        <div class="d-flex justify-content-center">
          <%= image_tag "empty.png", class: 'empty-image'%>
        </div>
      <% end %>
    </div>
   <div class="d-flex justify-content-between p-2">
     <%= simple_form_for [@chat, @message], method: :post,
           html: { class: 'w-100 text-area-div', controller: 'loading', multipart: true } do |f| %>
       <div class="d-flex align-items-center mb-0 gap-2 w-100">
         <%= f.hidden_field :who_sent, value: "user" %>
         <%= f.input :content,
                     as: :text,
                     required: false,
                     label: false,
                     wrapper: false,
                     input_html: { class: 'text-area-reset text-area-style', placeholder: "Write your draftâ€¦" } %>

         <!-- File input (multiple) -->
         <div class="d-flex align-items-center">
           <label class="btn btn-outline-secondary mb-0">
             <i class="fa-solid fa-paperclip"></i>
             <%= f.input :documents,
                         as: :file,
                         label: false,
                         input_html: {
                           multiple: true,
                           direct_upload: true,
                           accept: ".txt,.pdf,.docx,.csv,.md",
                           class: "d-none",
                           'data-action': 'change->loading#start'
                         } %>
           </label>
         </div>

         <button type="submit" class="btn text-black" data-action="click->loading#start">
           <i class="fa-solid fa-circle-up"></i>
         </button>
       </div>
     <% end %>
   </div>
  </div>
</div>
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasmessagenavbar" aria-labelledby="offcanvasmessagenavbarLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasmessagenavbarLabel">Old messages</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body" >
    <% @messages.each do |message| %>
      <% if message.who_sent === 'user' %>
        <div data-controller="messagenavbar">
          <%= link_to "#", class: "nav-link text-dark", data: { action: "click->messagenavbar#messageClick", messageId: message.id } do %>
            <div class="chat-box mb-2">
              <div class="date-text">
                <%= message.created_at.strftime("%B %d, %Y at %I:%M %p") %>
                <hr>
              </div>
              <p><%= simple_format(message.content) %></p>
              <% if message.who_sent == 'user' && message.documents.attached? %>
                <div class="mt-2">
                  <small class="text-muted">Attachments:</small>
                  <ul class="mb-0">
                    <% message.documents.each do |doc| %>
                      <li><%= link_to doc.filename.to_s, url_for(doc), target: "_blank", rel: "noopener" %></li>
                    <% end %>
                  </ul>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

